<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-error-reporting/advanced/ptrace" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Plugins for ptrace | Sauce Labs Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="robots" content="noindex, nofollow"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.saucelabs.com/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/ptrace/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Plugins for ptrace | Sauce Labs Documentation"><meta data-rh="true" name="description" content="pmodules allow users to augment snapshots by performing custom analysis and data structure pretty printing in response to specific events."><meta data-rh="true" property="og:description" content="pmodules allow users to augment snapshots by performing custom analysis and data structure pretty printing in response to specific events."><link data-rh="true" rel="canonical" href="https://docs.saucelabs.com/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/ptrace/"><link data-rh="true" rel="alternate" href="https://docs.saucelabs.com/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/ptrace/" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.saucelabs.com/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/ptrace/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RO95H65NEO-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-6735579-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="search" type="application/opensearchdescription+xml" title="Sauce Labs Documentation" href="/sauce-docs/pr-preview/pr-2917/opensearch.xml">

<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<script src="/scripts/hide.js"></script>
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" charset="UTF-8" data-domain-script="9e4c4ce3-8349-4030-9de7-0b1d368edfce"></script>
<script src="https://solve-widget.forethought.ai/embed.js" data-api-key="1f0243be-fd74-4205-bbff-cf72bc3c96b3" data-ft-location="docs"></script><link rel="stylesheet" href="/sauce-docs/pr-preview/pr-2917/assets/css/styles.f91667a7.css">
<script src="/sauce-docs/pr-preview/pr-2917/assets/js/runtime~main.b75675dc.js" defer="defer"></script>
<script src="/sauce-docs/pr-preview/pr-2917/assets/js/main.2fe8cf73.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/sauce-docs/pr-preview/pr-2917/"><div class="navbar__logo"><img src="/sauce-docs/pr-preview/pr-2917/img/sl-logo-horizontal-color-dark.svg" alt="Sauce Labs logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/sauce-docs/pr-preview/pr-2917/img/sl-logo-horizontal-color-neutral.svg" alt="Sauce Labs logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/sauce-docs/pr-preview/pr-2917/overview/">Docs</a><a class="navbar__item navbar__link" href="/sauce-docs/pr-preview/pr-2917/dev/api/">API</a><a class="navbar__item navbar__link" href="/sauce-docs/pr-preview/pr-2917/dev/cli/">CLI</a><a class="navbar__item navbar__link" href="/sauce-docs/pr-preview/pr-2917/visual-testing/">Visual (New)</a><a class="navbar__item navbar__link" href="/sauce-docs/pr-preview/pr-2917/testfairy/">Beta Testing</a><a class="navbar__item navbar__link" href="/sauce-docs/pr-preview/pr-2917/error-reporting/getting-started/">Error Reporting</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">Error Reporting</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/getting-started/">Getting Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/whats-new/">What&#x27;s New</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/platform-integrations/overview/">Platform Integrations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/web-console/getting-started/">Web Console Views</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/project-setup/attributes/">Project Settings</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/org-settings/user-mgmnt/">Organization Settings</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/security-compliance/audit-logs/">Privacy and Compliance</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/platform-overview/">Advanced</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/platform-overview/">Platform Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/package-installation/">Package Installation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/coroner/server-installation/">Coroner</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/traces-coroner/">Submitting Traces to Coroner</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/morgue/">Morgue</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/ptrace/">Plugins for ptrace</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/hydra/setup/">Hydra</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/assistive-unix/introduction/">Assistive Debugging for Unix</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/post-migration/">Post migration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/invariants/">Invariants</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/bcd/">BCD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/submission-buckets/">Submission Buckets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/sync-submissions/">Synchronous Submissions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/pam-ldap/">PAM-LDAP Authentication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/client-tools-unix/">Client Tools for UNIX</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/dwarf/">DWARF</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/snapshots/">Snapshot Generation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/error-processing-modifiers/">Error Processing Modifiers</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sauce-docs/pr-preview/pr-2917/error-reporting/troubleshooting/">Troubleshooting</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/sauce-docs/pr-preview/pr-2917/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Error Reporting</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Advanced</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Plugins for ptrace</span><meta itemprop="position" content="3"></li></ul></nav><div class="theme-doc-markdown markdown"><header><h1>Plugins for ptrace</h1></header><p><code>pmodules</code> allow users to enhance snapshots by performing custom analysis and pretty printing of data structures in response to specific events.</p>
<p>In this tutorial, we write a basic <code>pmodule</code> using the Lua API. The C API is similar; for that, you can refer to the documentation provided in <code>/opt/backtrace/include/ptrace/pmodule.h</code> from the <code>backtrace-ptrace-modules</code> package. For a full reference of the Lua API, you can see the Pmodule API page. The example module written here is reproduced in full at the top of the Pmodule API page.</p>
<p>From a pmodule&#x27;s perspective, a snapshot is generated during two phases: attach and postattach. We are in the attach phase when the ptrace tracer is attached to the target process, during which threads, frames, and variables are extracted. We are in the postattach phase after the ptrace tracer detaches from the process, at which point we have a fully populated backtrace object.</p>
<p>A pmodule can react to any of these events by registering a callback. The possible events are as follows:</p>
<ul>
<li><code>variable</code>: A new variable has been extracted (while attached to the process).</li>
<li><code>frame</code>: A new frame has been extracted (while attached).</li>
<li><code>thread</code>: A new thread has been extracted (while attached).</li>
<li><code>preattach</code>: Before ptrace attaches to the process.</li>
<li><code>postattach</code>: After ptrace detaches from the process.</li>
<li><code>attach</code>: Right after attachment, before extraction.</li>
</ul>
<p>Each callback receives relevant objects as arguments:</p>
<ul>
<li><code>variable</code>: A pmodule variable object and the underlying bt variable object. BT variables are discussed below.</li>
<li><code>frame</code>: A frame object.</li>
<li><code>thread</code>: A thread object.</li>
<li><code>preattach</code>: A backtrace object.</li>
<li><code>postattach</code>: A backtrace object.</li>
<li><code>attach</code>: A backtrace object.</li>
</ul>
<p>For example, you might want to pretty print a specific data structure if it appears in your snapshot. In that case, you can register a variable event callback with a filter specifying the type of variable you&#x27;re interested in (filters are covered in more detail below).</p>
<p>These event callbacks typically perform analysis or additional data extraction/formatting and augment the snapshot with additional classifiers, annotations, and more.</p>
<p>Now that we have a better understanding of a pmodule&#x27;s event-driven design, let&#x27;s start defining our module. At the global (chunk) scope, call <code>pmodule.define</code> like this:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The following functions are stubs; we&#x27;ll define a real load function later.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pmodule.define{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    id = &quot;pmodule_lua&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    load = function () pmodule.log(pmodule.log_level.warning, &quot;pm_load&quot;) end,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    unload = function () pmodule.log(pmodule.log_level.warning, &quot;pm_unload&quot;) end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>id</code> and <code>load</code> are required fields, while <code>unload</code> is optional. They are used as follows:</p>
<ul>
<li><code>id</code>: A string identifying your module.</li>
<li><code>load</code>: A function called to register all event callbacks, executed before the trace begins.</li>
<li><code>unload</code>: A function called before ptrace exits to perform any cleanup required by the module.</li>
</ul>
<p>When <code>pmodule.define</code> is called, it registers the module with the pmodule subsystem. Following this, the registered <code>load</code> function is invoked to establish event handlers as specified. Let&#x27;s examine an example <code>load</code> function:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">function pm_load()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.register(pmodule.event.postattach, postattach_cb)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local m = pmodule.match()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_object(&quot;crash&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_file(&quot;crash.c&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_frame_symbol(&quot;recurse&quot;, pmodule.match_type.substr)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_variable_base_type(&quot;crash_&quot;, pmodule.match_type.substr)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_variable_ptrace_type(pmodule.variable_type.tuple)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.register(pmodule.event.variable,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        function(var)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var:annotate(pmodule.annotation.critical, &quot;lua: struct var&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        end, m)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:reset()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:set_fault()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.register(pmodule.event.frame, frame_cb, m)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, we are interested in three types of events: the <code>postattach</code> event, <code>variable</code> extraction events, and <code>frame</code> events. We&#x27;ll cover examples of what we can do in each of these events, but for now, let&#x27;s focus on the match filters, starting with the one used for the variable event callback.</p>
<p>All of the object event callbacks (<code>variable</code>, <code>frame</code>, and <code>thread</code>) can be filtered by a match object. In this case, we specify that we are interested in a variable extracted from the object file <code>crash</code>, the compilation unit <code>crash.c</code>, whose frame&#x27;s symbol contains <code>recurse</code>, whose base type contains <code>crash_</code>, and whose variable type is a tuple (that is, a struct). Since we want to perform a simple action with this variable (annotate it with a useless message), we register the event with an anonymous function and this match filter.</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">local m = pmodule.match()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m:add_object(&quot;crash&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m:add_file(&quot;crash.c&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m:add_frame_symbol(&quot;recurse&quot;, pmodule.match_type.substr)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m:add_variable_base_type(&quot;crash_&quot;, pmodule.match_type.substr)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m:add_variable_ptrace_type(pmodule.variable_type.tuple)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pmodule.register(pmodule.event.variable,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    function(var)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        var:annotate(pmodule.annotation.critical, &quot;lua: struct var&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end, m)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, let&#x27;s look at the frame event registration. Here, we are interested in faulting frames, so we reset the match object (or you can use a different one), set it to match faulted objects, and then register the event using it.</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">m:reset()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m:set_fault()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pmodule.register(pmodule.event.frame, frame_cb, m)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>postattach</code> event registration call is straightforward, but we&#x27;ll delve deeper into that callback later.</p>
<p>Now that we register all our callbacks, our module is ready to start handling events. <code>ptrace</code> executes its registered callbacks, assuming any specified match filters pass. Let&#x27;s look at what we want to do when a faulted frame is extracted:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function frame_cb(fr)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for v, i in fr:fprm() do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        v:annotate(pmodule.annotation.critical, &quot;lua: fprm %d&quot;, i)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local signal = fr:siginfo()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if signal then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fr:backtrace():annotate(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            pmodule.annotation.json,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &#x27;{&quot;json&quot;: {&quot;context&quot;: &quot;Signal&quot;, \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;Reason&quot;: &quot;%s&quot;, \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;Populated&quot;: &quot;%s&quot;, \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;Address&quot;: &quot;%x&quot;, \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;Num&quot;: &quot;%d&quot;, \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;Code&quot;: &quot;%d&quot;, \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;String&quot;: &quot;%s&quot;}}&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            signal:reason(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            tostring(signal:address_populated()),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            signal:address(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            signal:num(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            signal:code(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            tostring(signal))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The example is simple: First, we annotate all parameters of the faulting frame (for illustrative purposes only; hydra indicates all frame parameters by surrounding them with <code>( )</code>). For many objects (which are discussed later), <code>pmodules</code> support Lua&#x27;s generic <code>for</code> interface. Here, we iterate over the frame&#x27;s parameters, which gives us a variable object and a parameter index for each iteration.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>All four main objects (variables, frames, threads, and the overarching backtrace) can be annotated.</p></div></div>
<p>Next, we want to pretty print signal information (again, just an example; hydra already has this pretty-printed under the faulting frame). We are annotating the backtrace object here, so the pretty-printed data is displayed in hydra&#x27;s Process pane. We are using the <code>json</code> annotation type for this. Refer to the Pmodule API documentation for more details on the expected format.</p>
<p>Now, let&#x27;s move on to the <code>postattach</code> callback:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function postattach_cb(bt)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local m = pmodule.match()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:set_fault()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- Example iterators.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for thr in bt, m do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        for fr in thr do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            for var in fr do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                if var:type() == pmodule.variable_type.reference then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    local addr = var:value()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    var:annotate(pmodule.annotation.critical,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        &quot;[%x] %s - example annotation&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        var:value(), var:name())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- Example global variable iteration.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.log(pmodule.log_level.warning, &quot;Global variables:&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for var, object, cu in bt:variables(), {object = &quot;crash&quot;, cu = &quot;invalid_write.c&quot;} do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        pmodule.log(pmodule.log_level.warning,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;name: %s, value: %s, object: %s, cu: %s&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var:name(), tostring(var:value()), object, cu)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- Example TLS variable iteration.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for thr in bt do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        pmodule.log(pmodule.log_level.warning, &quot;TLS variables:&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        for var, object, cu in thr:variables(), {cu = &quot;hang&quot;} do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            pmodule.log(pmodule.log_level.warning,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;name: %s, value: %s, object: %s, \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                cu: %s&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                var:name(), tostring(var:value()), object, cu)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- Example global variable lookup by name.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for var in bt:variables(), {name = &quot;global_version&quot;} do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        local str = pmodule.address_read_string(var:value(), 256)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        pmodule.log(pmodule.log_level.warning,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;[%x] string: %s&quot;, var:value(), str)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.log(pmodule.log_level.warning, &quot;process state: %d&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        bt:process_state())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    bt:add_kv_int(&quot;lua_key1&quot;, 42)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    bt:add_kv_string(&quot;lua_key2&quot;, &quot;lua_value&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    bt:add_classifier(&quot;lua&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, we start with iteration. The backtrace object, threads, and frames can be iterated over using Lua&#x27;s generic <code>for</code> interface. Each of these iterators accepts an optional match object via the invariant state (the second expression in the <code>for</code> loop&#x27;s expression list). In the first iterator, we iterate over all faulting threads.</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">local m = pmodule.match()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m:set_fault()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Example iterators.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for thr in bt, m do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for fr in thr do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        for var in fr do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            if var:type() == pmodule.variable_type.reference then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                local addr = var:value()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                var:annotate(pmodule.annotation.critical, &quot;[%x] %s - example annotation&quot;, var:value(), var:name())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The full backtrace is populated only in the <code>postattach</code> callback (which is why we perform the full iteration example there). In the thread callback, you are guaranteed the full thread is populated (with its frames and variables). In the frame callback, you are guaranteed the full frame is populated (with its variables).</p></div></div>
<p>Next, we&#x27;ll cover global and TLS variable iteration.</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Example global variable iteration.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pmodule.log(pmodule.log_level.warning, &quot;Global variables:&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for var, object, cu in bt:variables(), {object = &quot;crash&quot;, cu = &quot;invalid_write.c&quot;} do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.log(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        pmodule.log_level.warning,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;name: %s, value: %s, object: %s, cu: %s&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        var:name(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        tostring(var:value()),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        object,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        cu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Example TLS variable iteration.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for thr in bt do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.log(pmodule.log_level.warning, &quot;TLS variables:&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for var, object, cu in thr:variables(), {cu = &quot;hang&quot;} do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        pmodule.log(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            pmodule.log_level.warning,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;name: %s, value: %s, object: %s, \z</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                cu: %s&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            var:name(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            tostring(var:value()),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            object,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            cu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These iterations use the same generic <code>for</code> interface mentioned earlier for threads, frames, and other entities. The filter (invariant state) here is a table instead of a match object. The supported fields are:</p>
<ul>
<li><code>object</code>: The desired object file (substring match).</li>
<li><code>cu</code>: The desired compilation unit (substring match).</li>
<li><code>name</code>: The variable&#x27;s name (exact match).</li>
</ul>
<p>All of these fields (and the filter table itself) are optional. Each iteration returns a variable object, the object filename, and the compilation unit name.</p>
<p>Suppose we&#x27;re interested in a particular global variable - a variable containing the version of our program:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Example global variable lookup by name.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for var in bt:variables(), {name = &quot;global_version&quot;} do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local str = pmodule.address_read_string(var:value(), 256)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.log(pmodule.log_level.warning,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;[%x] string: %s&quot;, var:value(), str)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To find it, we use the global variable iterator with a name filter. It&#x27;s a C-string variable (that is, a pointer), so we use the global read API <code>pmodule.address_read_string</code> to read the string.</p>
<p>Suppose we&#x27;ve noticed something interesting (perhaps application-specific) about the data in our snapshot, and we want to classify the snapshot based on this. Your pmodule can use the following API for that:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- `bt` is a backtrace object.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bt:add_kv_int(&quot;lua_key1&quot;, 42)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bt:add_kv_string(&quot;lua_key2&quot;, &quot;lua_value&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bt:add_classifier(&quot;lua&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Previously, we mentioned <code>bt_variables</code>. Pmodules can use them to access specific fields in structures and iterate over arrays, linked lists, and other data structures.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p><code>bt_variables</code> themselves only allow access to member fields, which return new <code>bt_variables</code>; to extract actual data from them, they must first be synthesized into pmodule variables.</p></div></div>
<p>Here&#x27;s a full example:</p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--[[</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Assume we have these definitions:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct nested {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    int c;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct linkedstruct {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    STAILQ_ENTRY(linkedstruct) linkage;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    int v;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct somestruct {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    int a;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    double b;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    struct nested n;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    struct nested *np;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    struct nested **npp;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    struct nested ***nppp;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    STAILQ_HEAD(, linkedstruct) list;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    const char *s;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct array_struct {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    struct somestruct *kids;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    int len;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- And these global variables:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">static struct somestruct *some_struct_g;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">static struct array_struct papa;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- And the following population code:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">papa.kids = calloc(10, sizeof(struct somestruct));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (papa.kids == NULL) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fprintf(stderr, &quot;allocation failure&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    exit(EXIT_FAILURE);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">papa.len = 10;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">some_struct_g = calloc(1, sizeof *some_struct_g);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (some_struct_g == NULL) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fprintf(stderr, &quot;allocation failure&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    exit(EXIT_FAILURE);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">STAILQ_INIT(&amp;some_struct_g-&gt;list);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for (z = 0; z &lt; 10; ++z) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    struct linkedstruct *l;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    l = calloc(1, sizeof *l);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if (l == NULL) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        fprintf(stderr, &quot;allocation failure&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        exit(EXIT_FAILURE);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    l-&gt;v = z;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    STAILQ_INSERT_TAIL(&amp;some_struct_g-&gt;list, l, linkage);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">some_struct_g-&gt;a = 4;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">some_struct_g-&gt;b = 5;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">some_struct_g-&gt;n.c = 6;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">some_struct_g-&gt;np = &amp;some_struct_g-&gt;n;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">some_struct_g-&gt;npp = &amp;some_struct_g-&gt;np;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">some_struct_g-&gt;nppp = &amp;some_struct_g-&gt;npp;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">some_struct_g-&gt;s = &quot;kids&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for (z = 0; z &lt; 10; ++z) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    papa.kids[z].a = 9 + z;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    papa.kids[z].b = 9 + z;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    papa.kids[z].n.c = 9 + z;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    papa.kids[z].np = &amp;papa.kids[z].n;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    papa.kids[z].npp = &amp;papa.kids[z].np;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    papa.kids[z].nppp = &amp;papa.kids[z].npp;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    papa.kids[z].s = &quot;papa&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]] --</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function attach_cb(bt)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- Note: this is a global (Lua) variable.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- cached_ref_var will be nil if this fails. variable_cb will</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- attempt to use this, resulting in an exception if nil.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    cached_ref_var = pmodule.bt_query(&quot;some_struct_g&quot;, &quot;crash&quot;, &quot;crash.c&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local n = cached_ref_var.list.stqh_first</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local v = pmodule.variable_from_bt(n)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    while v:value() ~= 0 do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        local val = pmodule.variable_from_bt(n.v)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        print(string.format(&quot;[%x] %s: %d&quot;, val:address(), val:name(), val:value()))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        n = n.linkage.stqe_next</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        v = pmodule.variable_from_bt(n)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function variable_cb(var, raw)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- Variables synthesized this way will be finalized/freed. They cannot</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- be added to the snapshot. All synthesized variables must go through</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- the synthesis API.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- This is enforced through the API.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local n = pmodule.variable_from_bt(raw.len):value()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local addr = pmodule.variable_from_bt(raw.kids):value()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- We&#x27;ll use size to iterate over the array.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local size = pmodule.sizeof(pmodule.deref(cached_ref_var))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    print(string.format(&quot;addr: %x, len: %d, size: %d&quot;, addr, n, size))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for i = 0, n - 1 do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        local na = addr + i * size</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        print(string.format(&quot;--- iter %d (%x)---&quot;, i, na))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        elem = pmodule.deref(cached_ref_var, addr + i * size)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        print(string.format(&quot;a: %d&quot;, pmodule.variable_from_bt(elem.a):value()))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        print(string.format(&quot;b: %f&quot;, pmodule.variable_from_bt(elem.b):value()))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -- Note: when accessing member fields, pointers are</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -- automatically dereferenced until we reach the underlying</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -- struct.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        print(string.format(&quot;nppp.c: %d&quot;, pmodule.variable_from_bt(elem.nppp.c):value()))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">local function pm_load()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local m = pmodule.match()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_object(&quot;crash&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_file(&quot;crash.c&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_variable_base_type(&quot;array_struct&quot;, pmodule.match_type.substr)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_variable_ptrace_type(pmodule.variable_type.tuple)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    m:add_variable_name(&quot;papa&quot;, pmodule.match_type.substr)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.register(pmodule.event.variable, variable_cb, m)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pmodule.register(pmodule.event.attach, attach_cb)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pmodule.define {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    id = &quot;array_iter&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    load = pm_load</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A few CLI options exist to keep in mind when using pmodules:</p>
<ul>
<li><code>sandbox whitelist</code>: Allows certain Lua features to be used by Lua modules (disabled by default for better default security).</li>
<li><code>module-load/modules-path</code>: Loads modules from a specific file or directory.</li>
<li><code>module</code>: Passes key-value arguments to modules (modules are identified by their id name).</li>
</ul>
<p>For more details, consult the <code>ptrace -h</code> output.</p>
<p>That concludes this tutorial. We&#x27;ve covered how to register your pmodule with ptrace, how to register callbacks for events that interest you, how to iterate over various snapshot objects, and some of what you can do with individual objects. Of course, there&#x27;s more you can do in a pmodule. For a full reference, consult the pmodule API documentation.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/saucelabs/sauce-docs/edit/main/docs/error-reporting/advanced/ptrace.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2024-08-29T11:47:14.000Z" itemprop="dateModified">Aug 29, 2024</time></b> by <b>Kerem</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/morgue/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Morgue</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/sauce-docs/pr-preview/pr-2917/error-reporting/advanced/hydra/setup/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Setup</div></a></nav></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center footer__inner"><div class="margin-bottom--sm"><a href="https://saucelabs.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_fGS1"><img src="/sauce-docs/pr-preview/pr-2917/img/sl-logo-horizontal-color-neutral.svg" alt="Sauce Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/sauce-docs/pr-preview/pr-2917/img/sl-logo-horizontal-color-neutral.svg" alt="Sauce Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div></div><div class="footer-items"><h5><a href="https://saucelabs.com/">Sauce Labs</a></h5><h5><a href="https://stackoverflow.com/tags/saucelabs">Community</a></h5><h5><a href="https://opensource.saucelabs.com/">Open Source</a></h5><h5><a href="https://support.saucelabs.com/hc/en-us">Customer Support</a></h5></div><div class="footer-column"><span class="social-container"><p>Follow us</p><a href="https://www.facebook.com/saucelabs" target="_blank" data-ta="click" data-tc="Icon" data-tl="facebook" rel="noreferrer"><i class="svg svg-facebook"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-3 7h-1.924c-.615 0-1.076.252-1.076.889v1.111h3l-.238 3h-2.762v8h-3v-8h-2v-3h2v-1.923c0-2.022 1.064-3.077 3.461-3.077h2.539v3z"></path></svg></i></a><a href="https://www.linkedin.com/company/891955" target="_blank" data-ta="click" data-tc="Icon" data-tl="linkedin" rel="noreferrer"><i class="svg svg-linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></i></a><a href="https://twitter.com/saucelabs" target="_blank" data-ta="click" data-tc="Icon" data-tl="twitter" rel="noreferrer"><i class="svg svg-twitter"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-.139 9.237c.209 4.617-3.234 9.765-9.33 9.765-1.854 0-3.579-.543-5.032-1.475 1.742.205 3.48-.278 4.86-1.359-1.437-.027-2.649-.976-3.066-2.28.515.098 1.021.069 1.482-.056-1.579-.317-2.668-1.739-2.633-3.26.442.246.949.394 1.486.411-1.461-.977-1.875-2.907-1.016-4.383 1.619 1.986 4.038 3.293 6.766 3.43-.479-2.053 1.08-4.03 3.199-4.03.943 0 1.797.398 2.395 1.037.748-.147 1.451-.42 2.086-.796-.246.767-.766 1.41-1.443 1.816.664-.08 1.297-.256 1.885-.517-.439.656-.996 1.234-1.639 1.697z"></path></svg></i></a></span><span class="link-container"><ul><li><a class="link" href="https://saucelabs.com/privacy-policy" target="" data-ta="click" data-tc="Text" data-tl="">Privacy Policy</a></li><li><a class="link" href="https://saucelabs.com/terms-of-service" target="" data-ta="click" data-tc="Text" data-tl="">Terms of Service</a></li><li><a class="link" href="https://saucelabs.com/privacy-policy#eea" target="" data-ta="click" data-tc="Text" data-tl="">GDPR</a></li></ul></span></div><div></div><div class="footer__bottom text--center footer__inner"><div class="footer__copyright">© 2024 Sauce Labs, Inc. SAUCE and SAUCE LABS are registered trademarks owned by Sauce Labs Inc. in the United States, EU, and may be registered in other jurisdictions.</div></div></div></footer></div>
</body>
</html>